<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../img/favicon.ico">
  <title>Trip - Demo Docs</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="../css/highlight.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "Trip";
    var mkdocs_page_input_path = "Trip.md";
    var mkdocs_page_url = "/Trip/";
  </script>
  
  <script src="../js/jquery-2.1.1.min.js"></script>
  <script src="../js/modernizr-2.8.3.min.js"></script>
  <script type="text/javascript" src="../js/highlight.pack.js"></script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href=".." class="icon icon-home"> Demo Docs</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <a class="" href="..">Index</a>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">JavaScript Project Components</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../script/">script</a>
                </li>
                <li class="">
                    
    <a class="" href="../interface/">interface</a>
                </li>
                <li class="">
                    
    <a class="" href="../strom_client/">strom_client</a>
                </li>
                <li class="">
                    
    <a class="" href="../Map/">Map</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">Trip</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#trip-animating-a-ride">Trip - Animating a Ride</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../Driver/">Driver</a>
                </li>
                <li class="">
                    
    <a class="" href="../Route/">Route</a>
                </li>
                <li class="">
                    
    <a class="" href="../Point/">Point</a>
                </li>
    </ul>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="..">Demo Docs</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="..">Docs</a> &raquo;</li>
    
      
        
          <li>JavaScript Project Components &raquo;</li>
        
      
    
    <li>Trip</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h1 id="trip-animating-a-ride">Trip - Animating a Ride</h1>
<p>The Trip class is initialized by a driver object from the activeDrivers list on the Map object, and contains all the functions for animating a trip from an origin to a destination.</p>
<p>The Trip class has knowledge of:
    - Id: a unique identifier
    - Driver: its driver
    - Route: its route data
    - arrayLimiter: the size of packets sent to the server
    - Speed:
    - locationTempArr: an empty dummy array of location data prior to requesting the real location
    data from the database.
    - locationStreamArr: the array of trip coordinates from the database.
    - Color: the color of the trip (no longer used)
    - Trigger: a boolean value (defaulted to false) for controlling visibility of events
    - SpeedVector:
    - tripTurns:</p>
<p>The Trip class makes use of the following methods:</p>
<pre><code>setupLocationArr() {
  if (this.locationTempArr.length == this.arrayLimiter) {
    let data = this.locationTempArr.map(x =&gt; x);
    this.Driver.Client.process(this.Driver.name, this.Driver.name.replace(/\s/g, &quot;&quot;), data);
    let rollOver = this.locationTempArr.pop();
    this.locationTempArr.splice(0);
    this.locationTempArr.push(rollOver);
    sensorFailureCount = 0;
  }
}
</code></pre>

<pre><code>sendDataAjax(data) {
  // sends a packet of geo-codes to server to be streamed
  $.ajax({
    url: 'stream/collect',
    type: 'POST',
    data: data,
    dataType: 'json',
    success: console.log('data sent')
  });
}
</code></pre>

<pre><code>addRoute() {
  var rand = Math.floor(Math.random() * (this.Map.routes.length));
  this.Route = this.Map.routes[rand];
  this.Driver.location = this.Route.originCoords;
  this.SpeedVector = this.Route.speedVector.map(x =&gt; x);
}
</code></pre>

<pre><code>emitNoisy(failPercent, minorAbbPercent, majorAbbPercent) {
  let src = this.Map.getSource(`point-${this.Id}`);
  let loc = src._options.data.features[0].geometry.coordinates;
  // Add noise to location.
  // NOTE: 1 block ~ .001 lat/lng. Also, lat/lng numbers have 14 decimal places.
  if (Math.random() * 101 &lt; minorAbbPercent) {
    loc = loc.map(e =&gt; {
      let abb = (Math.random() * .001).toPrecision(11);
      if (Math.floor(Math.random() * 2) == 0) {
        e += abb;
      } else {
        e -= abb;
      }
    });
  }

  // Major abberations are the same as minor ones, but an order of magnitude larger.
  if (Math.random() * 101 &lt; majorAbbPercent) {
    loc = loc.map(e =&gt; {
      let abb = (Math.random() * .01).toPrecision(12);
      if (Math.floor(Math.random() * 2) == 0) {
        e += abb;
      } else {
        e -= abb;
      }
    });
  }

  // Package up to object to be sent to aggregation systems.
  let objectToEmit = {
    'id': this.Id,
    'location': loc,
    'timestamp': null,
    'driver-id': this.Driver.name,
    'region-code': 'PDX'
  };

  let tk = new Date();
  objectToEmit.timestamp = tk.getTime();
  // Push data to array if we didn't roll fail-to-emit
  if (Math.random() * 101 &gt; failPercent) {
    if(this.locationTempArr.length &lt;= this.arrayLimiter) {
      this.locationTempArr.push(this.Driver.Client.formatData(this.Driver.template, objectToEmit));
    };
  } else {
    sensorFailureCount++;
  }

  this.setupLocationArr(); //check if array is full every cycle | NOTE: this line (and the import of kafka.py) enables streaming
}
</code></pre>

<pre><code>animateRoute() {
  // A path line from origin to destination.
  var route = {
      'type': 'FeatureCollection',
      'features': [{
          'type': 'Feature',
          'geometry': {
              'type': 'LineString',
              'coordinates': this.Route.coords
          }
      }]
  };
  // A single point that animates along the route. The &quot;driver.&quot;
  // Coordinates are initially set to origin.
  var point = {
      'type': 'FeatureCollection',
      'features': [{
          'type': 'Feature',
          'geometry': {
              'type': 'Point',
              'coordinates': this.Route.originCoords
          }
      }]
  };

  // The location of an event.
  var eventPoint = {
      'type': 'FeatureCollection',
      'features': [{
          'type': 'Feature',
          'geometry': {
              'type': 'Point',
              'coordinates': this.Route.originCoords
          }
      }]
  };

  for(let i = 0; i &lt; this.Map.drivers.length; i++) {
    if(this.Map.drivers[i].location == undefined) {
      this.Map.drivers[i].location = this.Route.originCoords;
    };
  };

  // The target destination of a trip.
  let dest = {
    'type': 'FeatureCollection',
    'features': [{
        'type': 'Feature',
        'geometry': {
            'type': 'Point',
            'coordinates': this.Route.destCoords
        }
    }]
  };

  // Calculate the distance in kilometers between route start/end point.
  var lineDistance = turf.lineDistance(route.features[0], 'kilometers');
  var tweens = [];

  var numberOfFrames = 0;
  // NOTE: One possible optimization route is decreasing the resolution of the animations. I've made that easily controllable from within source by adding the variable below:
  var resolution = 40;
  // Draw an arc between the `origin` &amp; `destination` of the two points
  for (var i = 0; i &lt; resolution * lineDistance; i++) {
      var segment = turf.along(route.features[0], i / resolution, 'kilometers');
      tweens.push(segment.geometry.coordinates);
      numberOfFrames ++;
  }
  // console.log(`Frames in route: ${numberOfFrames}`);

  // Update the route with calculated arc coordinates
  route.features[0].geometry.coordinates = tweens;

  this.Map.addSource(`route-${this.Id}`, {
      'type': 'geojson',
      'data': route
  });

  this.Map.addSource(`point-${this.Id}`, {
      'type': 'geojson',
      'data': point
  });

  this.Map.addSource(`event-point-${this.Id}`, {
      'type': 'geojson',
      'data': eventPoint
  });

  this.Map.addSource(`dest-${this.Id}`, {
      'type': 'geojson',
      'data': dest
  });

  this.Map.addLayer({
    'id': `trip-route-${this.Id}`,
    'source': `route-${this.Id}`,
    'type': 'line',
    'paint': {
      'line-width': 4,
      'line-color': this.Color,
      'line-opacity': .4
    }
  });

  this.Map.addLayer({
      'id': `trip-point-${this.Id}`,
      'source': `point-${this.Id}`,
      'type': 'circle',
      'paint': {
          'circle-radius': 8,
          'circle-color': this.Color,
          'circle-translate': [5,-5]
      }
  });

  this.Map.addLayer({
    'id': `trip-dest-${this.Id}`,
    'source': `dest-${this.Id}`,
    'type': 'symbol',
    'layout': {
        'icon-image': 'alcohol-shop-15',
        'icon-offset': [0, 0],
        'text-offset': [0, 1],
        'text-field':  this.Driver.name
    },
    'paint': {
        'icon-color': this.Color,
    }
  });

  // add invisible layer to show events
  this.Map.addLayer({
    'id': `event-${this.Id}`,
    'source': `event-point-${this.Id}`,
    'type': 'symbol',
    'layout': {
      'text-offset': [0, 0]
    }
  });

  // Store the context of `this` using a variable so we can refer to the Trip object
  // as `this` inside functions.
  let myThis = this;

  function denoteTurn() {
    console.log(&quot;denoting turn&quot;);
    // Set the location of the eventPoint to the turn coordinates from the socket stream.
    eventPoint.features[0].geometry.coordinates = myThis.Driver.turnCoords;
    if (eventPoint &amp;&amp; myThis.Map.getSource(`event-point-${myThis.Id}`)) {
        myThis.Map.getSource(`event-point-${myThis.Id}`).setData(eventPoint);
    }
    // Define and render a Mapbox layer that contains a text-field that says &quot;Turn&quot;.
    myThis.Map.setLayoutProperty(`event-${myThis.Id}`, 'text-field', 'Turn');
    // Use a variable to preserve the context of `this` for the Trip object.
    let thus = myThis;
    // Toggle visibility off of the event by setting the text-field to an empty
    // string.
    setTimeout(function() {
      thus.Map.setLayoutProperty(`event-${thus.Id}`, 'text-field', &quot;&quot;);
    }, 500);
  }

  function turnCheck() {
    if (myThis.Driver.turnCount &gt; myThis.tripTurns) {
      myThis.tripTurns +=1;
      console.log(&quot;turn check&quot;);
      console.log(myThis.tripTurns);
      if (myThis.Trigger) {
        console.log(&quot;Trigger TRUE&quot;)
        denoteTurn();
      }
    }
  }

  function animate() {
      //Shorten route geometry and Route speed vector
      if (route.features[0].geometry.coordinates.length &gt; 1) {
        route.features[0].geometry.coordinates.splice(0, 1);
        myThis.SpeedVector.splice(0, 1);
      }
      // Update point geometry to a new position based on counter denoting
      // the index to access the arc.
      point.features[0].geometry.coordinates = route.features[0].geometry.coordinates[0];
      myThis.Driver.location = route.features[0].geometry.coordinates[0];
      if (!isNaN(Math.floor(myThis.SpeedVector[0]))){
          myThis.Speed = myThis.SpeedVector[0] + parseInt(myThis.Driver.speedModifier);
      } //else if (myThis.Speed == 85) {
      //     console.log(&quot;I'm a bad route! I started at &quot; + myThis.Route.origin + &quot; and I ended at &quot; + myThis.Route.destination);
      //     console.log(myThis.Route.speedVector);
      // }

      if (myThis.Speed &gt;= 96) {
          myThis.Color = '#2196f3'
      } else if (myThis.Speed &gt;= 91) {
          myThis.Color = '#5961D3'
      } else if (myThis.Speed &gt;= 86) {
          myThis.Color = '#6D56C0'
      } else if (myThis.Speed &gt;= 81) {
          myThis.Color = '#8646A6'
      }else if (myThis.Speed &gt;= 76) {
          myThis.Color = '#B02E7F'
      }else if (myThis.Speed &gt;= 71) {
          myThis.Color = '#CB1E64'
      }else if (myThis.Speed &gt;= 66) {
          myThis.Color = '#E70E48'
      } else {
          myThis.Color = '#f44336'
      }

      // Update the route source with the new data.
      myThis.Map.getSource(`route-${myThis.Id}`).setData(route);
      myThis.Map.setPaintProperty(`trip-route-${myThis.Id}`, 'line-color', myThis.Color);
      // Update the color of the circles
      myThis.Map.setPaintProperty(`trip-point-${myThis.Id}`,'circle-color', myThis.Color)
      // Update the source with this new data.
      myThis.Map.getSource(`point-${myThis.Id}`).setData(point);
      //myThis.Map.getSource(`event-point-${myThis.Id}`).setData(point);

      // Set the value of the Trigger attribute to the value of the eventDisplay attribute on the Map
      // object. We do this before calling turnCheck to make sure that we have the &quot;right&quot; boolean
      // value to display - or not display - any potential turns.
      myThis.Trigger = map.eventDisplay;

      turnCheck();

      myThis.emitNoisy(0, 0, 0);
      // Request the next frame of animation so long as destination has not
      // been reached.
      if (point.features[0].geometry.coordinates[0]
          !==
          route.features[0].geometry.coordinates[route.features[0].geometry.coordinates.length - 1][0]) {
        setTimeout(function() {
          requestAnimationFrame(animate);
        }, myThis.Speed);
      } else {
        myThis.complete();
      }
  }

  // Start the animation.
  animate();
}
</code></pre>

<pre><code>complete() {
  // Remove driver of Trip from the list of active drivers on the Map object.
  this.Map.activeDrivers.push(this.Driver);
  this.Driver.turnCount = 0;
  // remove trip from those listed on the map
  this.Map.trips.splice(
  this.Map.trips.indexOf(e =&gt; e.Id === this.Id), 1);
  this.Driver.isHired = false;
  // remove point and route layers from the map
  if (parseInt(this.Id) &gt; 2) {
      let last_id = parseInt(this.Id) - 2;
      this.Map.removeLayer(`event-${last_id}`);
      this.Map.removeSource(`event-point-${last_id}`);
  }
  // Remove trip layer from the map.
  this.Map.removeLayer(`trip-route-${this.Id}`);
  this.Map.removeLayer(`trip-point-${this.Id}`);
  this.Map.removeLayer(`trip-dest-${this.Id}`);
  // remove sources from the map
  this.Map.removeSource(`route-${this.Id}`);
  this.Map.removeSource(`point-${this.Id}`);
  this.Map.removeSource(`dest-${this.Id}`);
}
</code></pre>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../Driver/" class="btn btn-neutral float-right" title="Driver">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../Map/" class="btn btn-neutral" title="Map"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../Map/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../Driver/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '..';</script>
    <script src="../js/theme.js"></script>
      <script src="../search/require.js"></script>
      <script src="../search/search.js"></script>

</body>
</html>
